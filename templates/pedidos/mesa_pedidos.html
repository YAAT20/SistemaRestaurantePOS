{% extends "base.html" %}
{% block title %}Pedidos por Mesa{% endblock %}

{% block content %}
<div class="container my-4">
    <!-- Encabezado -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-primary mb-3 mb-md-0">
            <i class="fas fa-utensils me-2"></i> Mesas del Restaurante
        </h2>
        <a href="{% url 'pedidos:pedido_list' %}" class="btn btn-gradient btn-success shadow-sm">
            <i class="fas fa-list me-1"></i> Ver todos los pedidos
        </a>
    </div>

    <!-- Grid de mesas -->
    <div class="row g-3 row-cols-2 row-cols-md-3 row-cols-lg-4 row-cols-xl-5">
        {% for mesa_info in mesas_info %}
        <div class="col">
            <div class="card mesa-card shadow-sm border-0 h-100 
                {% if mesa_info.estado == 'OCUPADA' %}border-danger border-2{% else %}border-success border-2{% endif %}">
                <div class="card-body text-center d-flex flex-column">
                    <div class="rounded-circle p-3 mx-auto mb-2 shadow-sm
                        {% if mesa_info.estado == 'OCUPADA' %}bg-danger bg-opacity-25{% else %}bg-success bg-opacity-25{% endif %}"
                        style="width:70px; height:70px; display:flex; align-items:center; justify-content:center;">
                        <i class="fas fa-chair fs-3 
                            {% if mesa_info.estado == 'OCUPADA' %}text-danger{% else %}text-success{% endif %}">
                        </i>
                    </div>

                    <!-- Nombre y pedidos -->
                    <h5 class="card-title fw-bold mb-1">
                        Mesa {{ mesa_info.mesa.numero }}
                        {% if mesa_info.pedidos|length > 0 %}
                            <span class="badge bg-dark ms-1">{{ mesa_info.pedidos|length }}</span>
                        {% endif %}
                    </h5>

                    <!-- Estado -->
                    <p class="small mb-2">
                        {% if mesa_info.estado == "LIBRE" %}
                        <span class="badge bg-success px-3 py-1">Libre</span>
                        {% else %}
                        <span class="badge bg-danger px-3 py-1">Ocupada</span>
                        {% endif %}
                    </p>

                    <!-- Acciones -->
                    <div class="d-grid gap-2 mt-auto">
                        <a href="{% url 'pedidos:crear_pedido' %}?mesa={{ mesa_info.mesa.id }}"
                            class="btn btn-sm btn-primary shadow-sm">
                            <i class="fas fa-plus me-1"></i> Crear Pedido
                        </a>
                        <button class="btn btn-sm btn-outline-dark" data-bs-toggle="modal" data-bs-target="#modalMesa"
                            data-mesa-id="{{ mesa_info.mesa.id }}">
                            <i class="fas fa-eye me-1"></i> Ver pedidos
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="alert alert-info text-center shadow-sm">
                <i class="fas fa-info-circle me-1"></i> No hay mesas registradas.
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Modal de pedidos por mesa -->
<div class="modal fade" id="modalMesa" tabindex="-1" aria-labelledby="modalMesaLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content border-0 shadow-lg rounded-3">
            <div class="modal-header bg-gradient bg-primary text-white">
                <h5 class="modal-title fw-semibold" id="modalMesaLabel">
                    <i class="fas fa-receipt me-2"></i>Pedidos de la Mesa
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Cerrar"></button>
            </div>
            <div class="modal-body" id="modalMesaContent">
                <div class="text-center py-5 text-muted">
                    <div class="spinner-border text-primary mb-3" role="status"></div>
                    <p class="fw-semibold">Cargando pedidos...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Script AJAX -->
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const modal = document.getElementById("modalMesa");
        modal.addEventListener("show.bs.modal", async (event) => {
            const button = event.relatedTarget;
            const mesaId = button.getAttribute("data-mesa-id");
            const content = document.getElementById("modalMesaContent");

            content.innerHTML = `
                <div class="text-center py-5 text-muted">
                    <div class="spinner-border text-primary mb-3" role="status"></div>
                    <p class="fw-semibold">Cargando pedidos...</p>
                </div>`;

            try {
                let url = "{% url 'pedidos:mesa_fragment' 0 %}".replace("0", mesaId);
                const res = await fetch(url, {
                    headers: { "X-Requested-With": "XMLHttpRequest" }
                });

                if (!res.ok) throw new Error("Error HTTP: " + res.status);

                content.innerHTML = await res.text();
                document.getElementById("modalMesaLabel").textContent = "Pedidos de la Mesa " + mesaId;

            } catch (e) {
                content.innerHTML = `<div class="alert alert-danger shadow-sm">Error al cargar pedidos.</div>`;
                console.error(e);
            }
        });
    });
</script>
{% endblock %}
